+++
date = "2017-08-21T00:00:00Z"
title = "Adding Proxy Support Manually"
description = "Instructions for adding proxy support manually"
keywords= "proxy"
categories = [ "Knowledgebase", "Supporting Your Customers" ]
+++

## Adding Proxy Support Manually

This document describes the steps required to add proxy support to an existing installation.

The best way to configure Replicated to use a proxy server would be re-running the [Installation Script](/docs/distributing-an-application/installing/#installing-behind-a-proxy).

### Proxy Setting Validation

To validate that the proxy setting is correct and works with Replicated try using curl to hit the echo IP endpoint:
```
curl -x http://<proxy> https://api.replicated.com/market/v1/echo/ip
```

### Manually Adding Proxy Server Settings

The steps to setup the proxy depend on the Linux distribution: see [how to determine if the system is SysVInit or Systemd](/docs/kb/supporting-your-customers/adding-proxy-support-manually).


### List of known Linux distributions init systems.

Upstart: Ubuntu 10+, Fedora 9+, RHEL6, CentOS 6, AWS Linux 2014.3.2.

Systemd: Fedora 15+, RHEL7, Arch, Debian 8+, Ubuntu 15+, openSUSE 12.3+.

System V: RHEL5, Debian, SLES 11.

## Systemd

We first need to [setup Docker](https://docs.docker.com/engine/admin/systemd/#/http-proxy) with the proxy server configuration before configuring Replicated's proxy server settings.

After verifying Docker proxy settings are working correctly we will need to modify "/etc/sysconfig/replicated" and pass the variable HTTP_PROXY into REPLICATED_OPTS.

```
cat /etc/sysconfig/replicated
RELEASE_CHANNEL=stable
PRIVATE_ADDRESS=10.138.0.2
SKIP_OPERATOR_INSTALL=0
REPLICATED_OPTS="-e LOG_LEVEL=info -e HTTP_PROXY=http://10.128.0.4:3128 -e DAEMON_TOKEN=9qB38BngNIb9aiw6Aq8JCQ57t8H4yYfC -e NODENAME=replicated-qa.internal"
systemctl daemon-reload
```
The install may need to turn off proxy in Replicated and Docker to talk to our local registry. If you see any errors talking to the internal registry take the IP that it is trying to talk to and update

```
# add "-e NO_PROXY=172.17.0.1" to /etc/sysconfig/replicated at the end of REPLICATED_OPTS
```

```
# update /etc/systemd/system/docker.service.d/http-proxy.conf and add a NO_PROXY block
Environment="HTTP_PROXY=http://proxy.example.com:80/" "NO_PROXY=172.17.0.1"
```

```
# restart services
sudo systemctl daemon-reload
sudo systemctl restart docker
sudo systemctl restart replicated
sudo systemctl restart replicated-operator
```

## Upstart

Modify "/etc/default/docker" and add the environment variable http_proxy along with your proxy server settings.

```
cat /etc/default/docker
<-- cut -->
# Generated by replicated install script
export http_proxy="http://10.128.0.4:3128"
```

After verifying the Docker proxy setting are working correctly we will need to modify "/etc/default/replicated" and pass the variable HTTP_PROXY into REPLICATED_OPTS.

```
cat /etc/default/replicated
RELEASE_CHANNEL=stable
PRIVATE_ADDRESS=10.140.0.2
SKIP_OPERATOR_INSTALL=0
REPLICATED_OPTS="-e LOG_LEVEL=info -e HTTP_PROXY=http://10.128.0.4:3128 -e DAEMON_TOKEN=ndUuf8kLs06ldzu0tMu7GcZ27 -e NODENAME=replicated-qa.internal"
```

If you have internal Docker registries that you need to contact without proxying you can specify them via the NO_PROXY environment variable.

```
cat /etc/sysconfig/replicated
RELEASE_CHANNEL=stable
PRIVATE_ADDRESS=10.138.0.2
SKIP_OPERATOR_INSTALL=0
REPLICATED_OPTS="-e HTTP_PROXY=http://10.128.0.4:3128 -e NO_PROXY=localhost,127.0.0.1,docker-registry.localnetwork -e LOG_LEVEL=info -e DAEMON_TOKEN=KAEj1FxnRc507Uk7yTZA68U5gaJ3JhL -e NODENAME=replicated-qa.internal"
docker inspect replicated
<-- cut -->
            "Env": [
                "LOCAL_ADDRESS=10.138.0.2",
                "RELEASE_CHANNEL=stable",
                "HTTP_PROXY=http://10.128.0.4:3128",
                "NO_PROXY=localhost,127.0.0.1,docker-registry.localnetwork",
                "LOG_LEVEL=info",
                "DAEMON_TOKEN=KAEj1FxnRc507Uk7yTZA68U5gaJ3JhL",
                "NODENAME=malcolm-getelk.c.replicated-qa.internal",
                "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
<-- cut -->
```

The install may need to turn off proxy in Docker. If you see any errors talking to the internal registry take the IP that it is trying to talk to and update `/etc/default/docker` and add a NO_PROXY block or `export no_proxy="10.128.0.4"` as an example.

Restart docker

```
sudo restart docker
```
